<!doctype html>
<html lang="en">
<head>
    <title>Tag Search | Twitch API Example</title>
    <link rel="stylesheet" href="/twitch_misc/style.css" />

    <style>
div {
    box-sizing: content-box;
}
#results div {
    display: inline-block;
    width: 220px;
    vertical-align: top;
}
#results div.thumb {
    width: 100%;
    height: auto;
    aspect-ratio: 440 / 248;
    background-size: contain;
}
    </style>
</head>
<body>
    <p>This example first uses <a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth#oauth-implicit-code-flow" target="_blank">Implicit Auth</a> to get a token to use then will return a page similar to <a href="https://www.twitch.tv/directory" target="_blank">The Directory</a>. Generally calls will be done/cached server side with an <a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth#oauth-client-credentials-flow" target="_blank">App Access Token</a></p>

    <p>Get the code for this example on <a href="https://github.com/BarryCarlyon/twitch_misc/tree/main/examples/tag_search">Github</a> or just View the source instead</p>

    <a href="" id="authorize" target="barrysgithubtwitchauth">Authorize</a>
    <div id="loading"></div>

    <form action="" method="post" id="tagsearch"  class="disableit">
        <div>
            <input type="text" name="tag[]" class="tag" placeholder="Tag 1"/>
        </div>
        <div>
            <input type="text" name="tag[]" class="tag" placeholder="Tag 2"/>
        </div>
        <div>
            <input type="text" name="tag[]" class="tag" placeholder="Tag 3"/>
        </div>
        <div>
            <input type="submit" id="submit" value="Search" />
        </div>
    </form>

    <div id="results"></div>

    <script type="text/javascript">
        // go populate this with a client_id
        var client_id = 'hozgh446gdilj5knsrsxxz8tahr3koz';
        var redirect = 'https://' + window.location.host + '/twitch_misc/';
        // setup a memory space for the token
        var access_token = '';
        var page_counter = 0;
        var total_streams = 0;
        var page_record_viewer = 0;
        var tagsCounts = {};
        var tagSearch = [];

        document.getElementById('authorize').setAttribute('href', 'https://id.twitch.tv/oauth2/authorize?client_id=' + client_id + '&redirect_uri=' + encodeURIComponent(redirect) + '&response_type=token')

        function processToken(token) {
            access_token = token;

            document.getElementById('loading').textContent = `Ready`;
            //Loading Streams Page: ${page_counter} StreamCount: ${total_streams} ViewR0: ${page_record_viewer}`;
            tagsearch.classList.remove('disableit');
        }

        tagsearch.addEventListener('submit', (e) => {
            e.preventDefault();

            let tags = e.target.querySelectorAll('.tag');
            for (var x=0;x<tags.length;x++) {
                if (tags[x].value != '') {
                    tagSearch.push(tags[x].value.toLowerCase());
                }
            }

            getPage(null);
        });

        function getPage(after) {
            page_counter++;
            fetch(
                'https://api.twitch.tv/helix/streams?first=100' + (after ? '&after='+after : ''),
                {
                    method: 'GET',
                    headers: {
                        "Client-ID": client_id,
                        "Authorization": "Bearer " + access_token
                    }
                }
            )
            .then(resp => resp.json())
            .then(resp => {
                total_streams += resp.data.length;

                resp.data.forEach(stream => {
                    let { tags, viewer_count } = stream;
                    page_record_viewer = viewer_count;

                    if (tags && tags.length) {
                            let s = 0;
                        for (var x=0;x<tags.length;x++) {
                            for (var y=0;y<tagSearch.length;y++) {
                                if (tagSearch[y].toLowerCase() == tags[x].toLowerCase()) {
                                    s++;
                                }
                            }
                        }
                            if (s != tagSearch.length) {
                                return;
                            }
                            // match
                            //console.log(stream);

                            buildStream(stream);
                    }
                });

                document.getElementById('loading').textContent = `Loading Streams Page: ${page_counter} StreamCount: ${total_streams} ViewR0: ${page_record_viewer}`;
                if (resp.pagination && resp.pagination.cursor) {
                    getPage(resp.pagination.cursor);
                } else {
                    document.getElementById('loading').textContent = 'Got to end';
                }
            })
            .catch(err => {
                console.log(err);
                document.getElementById('loading').textContent = 'Something went wrong';
            });
        }

        function buildStream(stream) {
            let d = document.createElement('div');
            results.append(d);

            let { game_name, user_login, user_name, viewer_count, thumbnail_url, title } = stream;

            let thumb = document.createElement('div');
            thumb.classList.add('thumb');
            d.append(thumb);
            thumbnail_url = thumbnail_url.replace('{width}x{height}', '440x248');
            thumb.style.backgroundImage = `url(${thumbnail_url})`;

            let tit = document.createElement('div');
            tit.textContent = title;
            d.append(tit);
            let ul = document.createElement('div');

            let a = document.createElement('a');
            a.setAttribute('target', '_blank');
            a.setAttribute('href', `https://twitch.tv/${user_login}`);
            if (user_login.toLowerCase() == user_name.toLowerCase()) {
                a.textContent = user_name;
            } else {
                a.textContent = `(${user_login}) ${user_name}`;
            }
            let sp = document.createElement('span');
            sp.textContent = ` - ${game_name} - ${viewer_count}`;
            ul.append(sp);
            d.append(ul);
        }
    </script>
</body>