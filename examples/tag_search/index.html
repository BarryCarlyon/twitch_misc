<!doctype html>
<html lang="en">
<head>
    <title>Tag Search | Twitch API Example</title>
    <link rel="stylesheet" href="/twitch_misc/style.css" />

    <style>
div {
    box-sizing: content-box;
}
#tags>div {
    display: inline-block;
    padding: 2px 5px;
    border: 1px solid #FFFFFF;
    width: 15%;
}
#tags div div {
    display: inline-block;
    overflow: hidden;
    width: 50%;
}
.acount {
    text-align: right;
}
#tags {
    display: block;
    overflow: scroll;
    max-height: 300px;
}
    </style>
</head>
<body>
    <p>This example first uses <a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth#oauth-implicit-code-flow" target="_blank">Implicit Auth</a> to get a token to use then will return a page similar to <a href="https://www.twitch.tv/directory" target="_blank">The Directorty</a>.  Generally calls will be done/cached server side with an <a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth#oauth-client-credentials-flow" target="_blank">App Access Token</a></p>

    <p>Get the code for this example on <a href="https://github.com/BarryCarlyon/twitch_misc/tree/main/examples/tag_search">Github</a> or just View the source instead</p>

    <a href="" id="authorize" target="barrysgithubtwitchauth">Authorize</a>
    <div id="loading"></div>

    <form action="" method="post" id="tagsearch"  class="disableit">
        <div>
            <input type="text" name="tag[]" class="tag" placeholder="Tag 1"/>
        </div>
        <div>
            <input type="text" name="tag[]" class="tag" placeholder="Tag 2"/>
        </div>
        <div>
            <input type="text" name="tag[]" class="tag" placeholder="Tag 3"/>
        </div>
        <div>
            <input type="submit" id="submit" value="Search" />
        </div>
    </form>

    <div id="results"></div>

    <script type="text/javascript">
        // go populate this with a client_id
        var client_id = 'hozgh446gdilj5knsrsxxz8tahr3koz';
        var redirect = 'https://' + window.location.host + '/twitch_misc/';
        // setup a memory space for the token
        var access_token = '';
        var page_counter = 0;
        var total_streams = 0;
        var page_record_viewer = 0;
        var tagsCounts = {};
        var tagSearch = [];

        document.getElementById('authorize').setAttribute('href', 'https://id.twitch.tv/oauth2/authorize?client_id=' + client_id + '&redirect_uri=' + encodeURIComponent(redirect) + '&response_type=token')

        function processToken(token) {
            access_token = token;

            document.getElementById('loading').textContent = `Ready`;
            //Loading Streams Page: ${page_counter} StreamCount: ${total_streams} ViewR0: ${page_record_viewer}`;
            tagsearch.classList.remove('disableit');
        }

        tagsearch.addEventListener('submit', (e) => {
            e.preventDefault();

            let tags = e.target.querySelectorAll('.tag');
            for (var x=0;x<tags.length;x++) {
                if (tags[x].value != '') {
                    tagSearch.push(tags[x].value.toLowerCase());
                }
            }

            getPage(null);
        });

        function getPage(after) {
            page_counter++;
            fetch(
                'https://api.twitch.tv/helix/streams?first=100' + (after ? '&after='+after : ''),
                {
                    method: 'GET',
                    headers: {
                        "Client-ID": client_id,
                        "Authorization": "Bearer " + access_token
                    }
                }
            )
            .then(resp => resp.json())
            .then(resp => {
                total_streams += resp.data.length;

                resp.data.forEach(stream => {
                    let { tags, viewer_count } = stream;
                    page_record_viewer = viewer_count;

                    if (tags && tags.length) {
                            let s = 0;
                        for (var x=0;x<tags.length;x++) {
                            for (var y=0;y<tagSearch.length;y++) {
                                if (tagSearch[y].toLowerCase() == tags[x].toLowerCase()) {
                                    s++;
                                }
                            }
                        }
                            if (s != tagSearch.length) {
                                return;
                            }
                            // match
                            //console.log(stream);

                            buildStream(stream);
                    }
                });

                document.getElementById('loading').textContent = `Loading Streams Page: ${page_counter} StreamCount: ${total_streams} ViewR0: ${page_record_viewer}`;
                if (resp.pagination && resp.pagination.cursor) {
                    getPage(resp.pagination.cursor);
                }
            })
            .catch(err => {
                console.log(err);
                document.getElementById('loading').textContent = 'Something went wrong';
            });
        }

        function buildStream(stream) {
            let d = document.createElement('div');
            results.append(d);
            d.style.display = "inline-block";
            d.style.width = "220px";

            let { game_name, user_login, viewer_count, thumbnail_url, title } = stream;

            let thumb = document.createElement('div');
            d.append(thumb);
            thumb.style.width = "220px"
            thumb.style.height = "124px";
            thumbnail_url = thumbnail_url.replace('{width}x{height}', '440x248');
            thumb.style.background = `url(${thumbnail_url})`;
            thumb.style.backgroundSize = "contain";

            let tit = document.createElement('div');
            tit.textContent = title;
            d.append(tit);
            let ul = document.createElement('div');
            ul.textContent = `${user_login} - ${game_name} - ${viewer_count}`;
            d.append(ul);
        }
    </script>
</body>