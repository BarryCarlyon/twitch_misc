<html>
<head>
    <title>Guest Star | Twitch API Example</title>
    <link rel="stylesheet" href="/twitch_misc/style.css" />
</head>
<body>
    <p>This example will first ask you to login with <a href="https://dev.twitch.tv/docs/authentication/getting-tokens-oauth#oauth-implicit-code-flow" target="_blank">Implicit Auth</a> to get an API Token to use.</p>
    <p>Get the code for this example on <a href="https://github.com/BarryCarlyon/twitch_misc/tree/main/examples/guest_star">Github</a> or just View the source instead</p>
    <ul>
        <li>
            <a href="" id="authorize" target="barrysgithubtwitchauth">Authorize with Twitch</a>
        </li>
    </ul>
    <p>After testing you can Disconnect the "Barry's GitHub Examples" Application on the <a href="https://www.twitch.tv/settings/connections">Connections page</a></p>

    <div id="status_bar"></div>

    <div id="selector" style="display: none;">
        <form action="" method="post">
            <fieldset>
                <div style="width: 30%; display: inline-block;">
                    <input type="text" id="moderate_channel_name" placeholder="Control a Channel" />
                </div>
                <div style="width: 30%; display: inline-block;">
                    <input type="button" id="moderate_channel" value="Moderate" />
                </div>
                <div style="width: 30%; display: inline-block;">
                    <input type="button" id="control_channel" value="My Own" />
                </div>
            </fieldset>
        </form>
    </div>
    <div id="controls" style="display: none;">
        <div id="master_controls" style="display: flex;">
            <input type="button" id="master_control" data-function="start_stop" value="Start Guest Star" />
        </div>
        <div id="ui" style="display: flex;">
            <div id="invite_manager" style="width: 33%;">
                <form action="" method="post" id="invite_username_form">
                    <fieldset>
                        <legend>Create Invite</legend>
                        <input type="text" name="invite_username" id="invite_username" placeholder="Username" />
                    </fieldset>
                </form>
                <table id="invite_manager_list"></table>
            </div>
            <div style="width: 66%;">
                <div id="settings">
                    <form action="" method="post" id="settings_form">
                        <fieldset style="display: flex">
                            <div class="form-group">
                                <label>Moderator can Live</label>
                                <input type="checkbox" name="is_moderator_send_live_enabled" id="is_moderator_send_live_enabled" />
                            </div>
                            <div class="form-group" style="width: 25%; display: inline-block;">
                                <label>Slot Count</label>
                                <select name="slot_count" id="slot_count">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Audio Enabled</label>
                                <input type="checkbox" name="is_browser_source_audio_enabled" id="is_browser_source_audio_enabled" />
                            </div>
                            <div class="form-group">
                                <label>Layout</label>
                                <select name="group_layout" id="group_layout">
                                    <option value="TILED">Tiled</option>
                                    <option value="SCREENSHARE">Screenshare</option>
                                </select>
                            </div>
                        </fieldset>
                        <input type="submit" value="Update Settings" />
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="eventsub.js"></script>
    <script type="text/javascript">
        // These are set for the GitHub Pages Example
        // Substitute as needed
        var client_id = 'hozgh446gdilj5knsrsxxz8tahr3koz';
        var redirect = `https://${window.location.host}/twitch_misc/`;
        var access_token = '';

        let commonHeaders = {};
        let broadcaster_id = '';
        let moderator_id = '';
        let active_session_id = '';

        document.getElementById('authorize').setAttribute('href', 'https://id.twitch.tv/oauth2/authorize?client_id=' + client_id + '&redirect_uri=' + encodeURIComponent(redirect) + '&response_type=token&scope=channel:manage:guest_star+moderator:manage:guest_star');

        async function getUserData(username) {
            let url = new URL('https://api.twitch.tv/helix/users');
            if (username) {
                url.search = new URLSearchParams([
                    [ 'login', username ]
                ]);
            }
            let resp = await fetch(
                url,
                {
                    method: 'GET',
                    headers: {
                        ...commonHeaders
                    }
                }
            );
            if (resp.status != 200) {
                status_bar.textContent = 'Failed to user lookup: ' + await resp.text();
                return;
            }
            let data = await resp.json();
            if (data.data.length == 1) {
                return data.data[0];
            }
            status_bar.textContent = 'Failed to find user';
        }

        async function processToken(token) {
            access_token = token;

            commonHeaders = {
                'Accept': 'application/json',
                'Client-ID': client_id,
                'Authorization': `Bearer ${access_token}`
            }

            status_bar.classList.add('show');
            status_bar.textContent = 'Loading';

            let moderator = await getUserData();
            moderator_id = moderator.id;

            selector.style.display = 'block';
        }

        moderate_channel.addEventListener('click', (e) => {
            let user = getUserData(moderate_channel_name.textContent);

            broadcaster_id = user.id;

            initGuestStar();
        });
        control_channel.addEventListener('click', (e) => {
            broadcaster_id = moderator_id;

            initGuestStar();
        });

        // control functions
        controls.addEventListener('click', async (e) => {
            let func = e.target.getAttribute('data-function');
            if (!func) {
                return;
            }
            e.preventDefault();

            switch (func) {
                case 'start':
                    var req = await fetch(
                        `https://api.twitch.tv/helix/guest_star/session?broadcaster_id=${broadcaster_id}`,
                        {
                            method: 'POST',
                            headers: {
                                ...commonHeaders
                            }
                        }
                    );
                    if (req.status != 200) {
                        status_bar.textContent = 'Failed to Start Guest Star Session: ' + await req.text();
                        return;
                    }

                    var resp = await req.json();
                    if (resp.data.length != 1) {
                        status_bar.textContent = 'Not one Guest Star Session';
                        return;
                    }
                    //var { id } = resp.data[0];
                    //active_session_id = id;

                    status_bar.textContent = 'Started a Guest Star Session';
                    loadSession();
                    return;
                case 'stop':
                    var req = await fetch(
                        `https://api.twitch.tv/helix/guest_star/session?broadcaster_id=${broadcaster_id}&session_id=${active_session_id}`,
                        {
                            method: 'DELETE',
                            headers: {
                                ...commonHeaders
                            }
                        }
                    );
                    if (req.status != 200) {
                        status_bar.textContent = 'Failed to Stop Guest Star Session: ' + await req.text();
                        return;
                    }
                    status_bar.textContent = 'Stopped Guest Star Session';
                    loadSession();
                    break;
                case 'delete_invite':
                    var req = await fetch(
                        `https://api.twitch.tv/helix/guest_star/invtites?broadcaster_id=${broadcaster_id}&moderator_id=${moderator_id}&session_id=${active_session_id}&guest_id=${e.target.getAttribute('data-user-id')}`,
                        {
                            method: 'DELETE',
                            headers: {
                                ...commonHeaders
                            }
                        }
                    );
                    if (req.status != 200) {
                        status_bar.textContent = 'Failed to Delete Invite: ' + await req.text();
                        return;
                    }
                    status_bar.textContent = 'Deleted Invite';
                    loadSession();
                    break;
            }
        });

        let eventSubController;
        // go
        async function initGuestStar() {
            selector.style.display = 'none';
            controls.style.display = 'block';

            // lets connect to eventsub
            stauts_bar = 'Spawning EventSub';
            eventSubController = new initSocket(true);
            eventSubController.on('connected', (id) => {
                status_bar.textContent = `Connected to EventSub WebSockets with ${id}`;

                console.log(eventSubController.eventsub.twitch_websocket_id);

                // subscribe
                requstEventSub('channel.guest_star_session.begin', 'beta', { broadcaster_user_id: broadcaster_id });
                requstEventSub('channel.guest_star_session.end', 'beta', { broadcaster_user_id: broadcaster_id });
                requstEventSub('channel.guest_star_guest.update', 'beta', { broadcaster_user_id: broadcaster_id, moderator_user_id: moderator_id });
                requstEventSub('channel.guest_star_slot.update', 'beta', { broadcaster_user_id: broadcaster_id, moderator_user_id: moderator_id });
                requstEventSub('channel.guest_star_settings.update', 'beta', { broadcaster_user_id: broadcaster_id, moderator_user_id: moderator_id });
            });

            bindEventSubTriggers();

            // lets load current status
            loadSession();
            loadSettings();
        }

        async function requstEventSub(type, version, condition) {
            return fetch(
                'https://api.twitch.tv/helix/eventsub/subscriptions',
                {
                    method: "POST",
                    headers: {
                        ...commonHeaders,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type,
                        version,
                        condition,
                        transport: {
                            method: "websocket",
                            session_id: eventSubController.eventsub.twitch_websocket_id
                        }
                    })
                }
            );
        }

        async function loadSession() {
            let url = new URL('https://api.twitch.tv/helix/guest_star/session');
            url.search = new URLSearchParams([
                [ 'broadcaster_id', broadcaster_id ],
                [ 'moderator_id', moderator_id ]
            ]);
            let request = await fetch(
                url,
                {
                    method: 'GET',
                    headers: {
                        ...commonHeaders
                    }
                }
            );
            if (request.status != 200) {
                status_bar.textContent = 'Failed to get Session Status: ' + await resp.text();
                return;
            }
            let session = await request.json();
            console.log('The session count is', session.data.length);
            if (session.data.length != 1) {
                // no session
                master_control.setAttribute('data-function', 'start');
                master_control.value = 'Start Guest Star';
                return;
            }
            master_control.setAttribute('data-function', 'stop');
            master_control.value = 'End Guest Star';

            let { id } = session.data[0];
            active_session_id = id;

            // process slots
            // check invites
            refreshInvites();
            clearInterval(refreshInvitesTimer);
            refreshInvitesTimer = setInterval(refreshInvites, 5000);
        }
        let refreshInvitesTimer = false;
        async function refreshInvites() {
            let url = new URL('https://api.twitch.tv/helix/guest_star/invites');
            url.search = new URLSearchParams([
                [ 'broadcaster_id', broadcaster_id ],
                [ 'moderator_id', moderator_id ],
                [ 'session_id', active_session_id ]
            ]);

            let invite = await fetch(
                url,
                {
                    method: 'GET',
                    headers: {
                        ...commonHeaders
                    }
                }
            );
            let invited = await invite.json();

            invite_manager_list.textContent = '';

            if (invited.data.length == 0) {
                return;
            }

            let user_ids = [];

            for (let x=0;x<invited.data.length;x++) {
                let { user_id, invited_at, status } = invited.data[x];

                user_ids.push([ 'id', user_id ]);

                let r = invite_manager_list.insertRow();
                var c = r.insertCell();
                c.setAttribute('data-user-id', user_id);
                c.textContent = user_id;
                var c = r.insertCell();
                c.textContent = status;
                var c = r.insertCell();
                c.textContent = invited_at;
                
                var c = r.insertCell();
                let kill_invite = document.createElement('button');
                kill_invite.textContent = 'x';
                kill_invite.setAttribute('data-user-id', user_id);
                kill_invite.setAttribute('data-function', 'delete_invite')
            }

            let users = new URL('https://api.twitch.tv/helix/users');
            users.search = new URLSearchParams(user_ids);

            let userLookup = await fetch(
                users,
                {
                    method: 'GET',
                    headers: {
                        ...commonHeaders
                    }
                }
            );
            let userData = await userLookup.json();
            userData.data.forEach(user => {
                let { id, display_name } = user;
                document.querySelector(`td[data-user-id="${id}"]`).textContent = display_name;
            });
        }

        async function loadSettings() {
            let url = new URL('https://api.twitch.tv/helix/guest_star/channel_settings');
            url.search = new URLSearchParams([
                [ 'broadcaster_id', broadcaster_id ]
            ]);
            let request = await fetch(
                url,
                {
                    method: 'GET',
                    headers: {
                        ...commonHeaders
                    }
                }
            );
            if (request.status != 200) {
                status_bar.textContent = 'Failed to get Settings: ' + await resp.text();
                return;
            }
            let session = await request.json();

            let { is_moderator_send_live_enabled, slot_count, is_browser_source_audio_enabled, group_layout } = session.data[0];
            if (is_moderator_send_live_enabled) {
                document.querySelector('input[name="is_moderator_send_live_enabled"]').setAttribute('checked', 'checked');
            } else {
                document.querySelector('input[name="is_moderator_send_live_enabled"]').removeAttribute('checked');
            }
            document.querySelector('select[name="slot_count"]').value = slot_count;
            if (is_browser_source_audio_enabled) {
                document.querySelector('input[name="is_browser_source_audio_enabled"]').setAttribute('checked', 'checked');
            } else {
                document.querySelector('input[name="is_browser_source_audio_enabled"]').removeAttribute('checked');
            }
            document.querySelector('select[name="group_layout"]').value = group_layout.toUpperCase();
        }

        // functions
        invite_username_form.addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log('create invite');

            let username = invite_username.value;
            let userData = await getUserData(username);

            // send invite
            let invite = await fetch(
                'https://api.twitch.tv/helix/guest_star/invites',
                {
                    method: 'POST',
                    headers: {
                        ...commonHeaders,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        broadcaster_id,
                        moderator_id,
                        session_id: active_session_id,
                        guest_id: userData.id
                    })
                }
            );
            if (invite.status == 204) {
                // yay
                status_bar.textContent = `Invite sent to ${username}`;
                return;
            }

            let data = await invite.json();
            status_bar.textContent = `Failed to invite ${username} - ${data.message}`;
        });
        settings_form.addEventListener('submit', async (e) => {
            e.preventDefault();

            console.log('submitting settings');

            let revise = await fetch(
                'https://api.twitch.tv/helix/guest_star/channel_settings',
                {
                    method: 'PATCH',
                    headers: {
                        ...commonHeaders,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        broadcaster_id,

                        is_moderator_send_live_enabled: (is_moderator_send_live_enabled.checked),
                        slot_count: slot_count.value,
                        is_browser_source_audio_enabled: (is_browser_source_audio_enabled.checked),
                        group_layout: group_layout.value
                    })
                }
            );
            if (revise.status == 204) {
                // yay
                status_bar.textContent = `Settings Revised`;
                return;
            }

            let data = await revise.json();
            status_bar.textContent = `Failed to Revise Settings - ${data.message}`;
        });





        function bindEventSubTriggers() {
            eventSubController.on('channel.guest_star_session.begin', ({ metadata, payload }) => {
                let { session_id } = payload.event;
                active_session_id = session_id;

                master_control.setAttribute('data-function', 'stop');
                master_control.value = 'End Guest Star';
            });
            eventSubController.on('channel.guest_star_session.end', ({ metadata, payload }) => {
                active_session_id = '';

                master_control.setAttribute('data-function', 'start');
                master_control.value = 'Start Guest Star';
            });
            eventSubController.on('channel.guest_star_settings.update', ({ metadata, payload }) => {
                let { is_moderator_send_live_enabled, slot_count, is_browser_source_audio_enabled, browser_source_group_layout } = payload.event;

                if (is_moderator_send_live_enabled) {
                    document.querySelector('input[name="is_moderator_send_live_enabled"]').setAttribute('checked', 'checked');
                } else {
                    document.querySelector('input[name="is_moderator_send_live_enabled"]').removeAttribute('checked');
                }
                document.querySelector('select[name="slot_count"]').value = slot_count;
                if (is_browser_source_audio_enabled) {
                    document.querySelector('input[name="is_browser_source_audio_enabled"]').setAttribute('checked', 'checked');
                } else {
                    document.querySelector('input[name="is_browser_source_audio_enabled"]').removeAttribute('checked');
                }
                document.querySelector('select[name="group_layout"]').value = browser_source_group_layout.toUpperCase();
            });
        }
    </script>
</body>
</html>
