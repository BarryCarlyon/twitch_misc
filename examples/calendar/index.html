<!doctype html>
<html lang="en">
<head>
    <title>Calendar Stuff | Twitch API Example</title>
    <link rel="stylesheet" href="/twitch_misc/style.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/williamtroup/Calendar.js@main/dist/calendar.js.min.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/williamtroup/Calendar.js@main/dist/calendar.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ical.js@1.5.0/build/ical.min.js"></script>
</head>
<body>

<div id="calendar"></div>

<script type="text/javascript">
    let icals = [
        '26610234',
        '15185913',
        '23735582',
        '7236692',
        '10817445'
    ]

    function parseIcalData(icalText) {
        if (!icalText) {
            return [];
        }
        const jcalData = ICAL.parse(icalText);
        const comp = new ICAL.Component(jcalData);
        const vevents = comp.getAllSubcomponents("vevent");

        const events = [];
        vevents.forEach((vevent) => {
            const event = new ICAL.Event(vevent);

            console.log(vevent);

            events.push({
                title: event.summary,
                from: event.startDate.toJSDate(),
                to: event.endDate.toJSDate(),
                description: event.description ?? 'Some Description',
            });
        });
        return events;
    }

    const calendarInstance = new calendarJs( "calendar" );

    let icalTemplate = 'https://api.twitch.tv/helix/schedule/icalendar?broadcaster_id={id}';
    async function loadFeed(broadcasterId) {
        let req = await fetch(
            icalTemplate.replace('{id}', broadcasterId),
        );
        let icalText = await req.text();
        let events = parseIcalData(icalText);

        if (events.length == 0) {
            console.log('got no events');
            return;
        }
        console.log('got events', events);

        calendarInstance.addEvents(events);
        //calendarInstance.refresh();
    }
</script>

</body>
</html>inde