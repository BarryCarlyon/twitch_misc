<!doctype html>
<html lang="en">
<head>
    <title>Calendar Stuff | Twitch API Example</title>
    <link rel="stylesheet" href="/twitch_misc/style.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/williamtroup/Calendar.js@main/dist/calendar.js.min.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/williamtroup/Calendar.js@main/dist/calendar.min.js"></script>
    <script src="https://unpkg.com/ical.js/dist/ical.es5.min.cjs"></script>
</head>
<body>

<div id="calendar"></div>

<script type="text/javascript">
    let icals = [
        '26610234',
        '15185913',
        '23735582',
        '7236692',
        '10817445'
    ]

    const calendarInstance = new calendarJs( "calendar" );

    let icalTemplate = 'https://api.twitch.tv/helix/schedule/icalendar?broadcaster_id={id}';
    async function loadFeed(broadcasterId) {
        let req = await fetch(
            icalTemplate.replace('{id}', broadcasterId),
        );
        let icalText = await req.text();


        let icalParsed = ICAL.parse(icalText);
        let compData = new ICAL.Component(icalParsed);
        let vevents = compData.getAllSubcomponents("vevent");


        const events = [];
        vevents.forEach((vevent) => {
            const event = new ICAL.Event(vevent);
            /*
            console.log('EVT', event);
            console.log(event.summary);
            console.log(event.startDate);
            console.log(event.endDate);
            console.log(event.recur);
            */

            console.log(event);
            /*
            events.push({
                title: event.summary,
                from: event.startDate.toJSDate(),
                to: event.endDate.toJSDate(),
                description: event.description ?? '',
            });
            */

            let expand = new ICAL.RecurExpansion({
                component: vevent,
                dtstart: vevent.getFirstPropertyValue('dtstart')
            });

            // next is always an ICAL.Time or null
            let next;
            let counter = 0;

            while (counter < 52 && (next = expand.next())) {
                counter++;
                //console.log(next);

                events.push({
                    title: event.summary,
                    from: next.toJSDate(),
                    to: next.toJSDate(),
                    description: event.description ?? '',
                });
            }
        });

        calendarInstance.addEvents(events);
    }
</script>

</body>
</html>