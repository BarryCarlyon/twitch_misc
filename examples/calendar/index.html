<!doctype html>
<html lang="en">
<head>
    <title>Calendar Stuff | Twitch API Example</title>
    <link rel="stylesheet" href="/twitch_misc/style.css" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/williamtroup/Calendar.js@main/dist/calendar.js.min.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/williamtroup/Calendar.js@main/dist/calendar.min.js"></script>
    <script src="https://unpkg.com/ical.js/dist/ical.es5.min.cjs"></script>
</head>
<body>

<div id="calendar"></div>

<script type="text/javascript">
    let icalTemplate = 'https://api.twitch.tv/helix/schedule/icalendar?broadcaster_id={id}';
    let icals = [
        '26610234',
        '15185913',
        '23735582',
        '7236692',
        '10817445'
    ]

    const calendarInstance = new calendarJs( "calendar" );

    async function loadFeed(broadcasterId) {
        // fetch the iCal feed from twitch
        // we'll template replace the URI here.
        // https://dev.twitch.tv/docs/api/reference/#get-channel-icalendar
        let req = await fetch(
            icalTemplate.replace('{id}', broadcasterId),
        );
        if (req.status != 200) {
            // just in case of bad/banned TwitchID...
            return;
        }
        // to text
        let icalText = await req.text();

        let icalParsed = ICAL.parse(icalText);
        let compData = new ICAL.Component(icalParsed);
        let vevents = compData.getAllSubcomponents("vevent");

        const events = [];
        vevents.forEach((vevent) => {
            const event = new ICAL.Event(vevent);

            /*
            // we pass to the recurrence loop to render with instead of rendering ONE event
            events.push({
                title: event.summary,
                from: event.startDate.toJSDate(),
                to: event.endDate.toJSDate(),
                description: event.description ?? '',
            });
            */
            // tidy
            if (event.summary == '') {
                event.summary = 'A Stream';
            }

            let expand = new ICAL.RecurExpansion({
                component: vevent,
                dtstart: vevent.getFirstPropertyValue('dtstart')
            });

            // next is always an ICAL.Time or null
            let next;
            let counter = 0;

            // @tofix: account for what is start date of shown calendar

            // https://github.com/kewisch/ical.js/wiki/Parsing-iCalendar#recurring-events
            // RFC https://datatracker.ietf.org/doc/html/rfc5545
            // ical time https://kewisch.github.io/ical.js/api/ICAL.Time.html

            // do event start date which is LAWD knows when
            // and render the next 52 weeks...
            while (counter < 52 && (next = expand.next())) {
                counter++;

                // add the event and lock it
                // otherwise viewers can drag shit around
                events.push({
                    title: event.summary,
                    from: next.toJSDate(),
                    to: next.toJSDate(),
                    locked: true
                });
            }
        });

        calendarInstance.addEvents(events);
    }

    for (var idx in icals) {
        loadFeed(icals[idx]);
    }
</script>

</body>
</html>